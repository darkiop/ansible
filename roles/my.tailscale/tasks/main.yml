- name: "Import ip-forwarding.yml"
  ansible.builtin.import_tasks: ip-forwarding.yml

- name: Ensure curl is present (needed for install script path)
  ansible.builtin.package:
    name: curl
    state: present

- name: Check if tailscale is already installed
  ansible.builtin.command: tailscale version
  register: _ts_version
  failed_when: false
  changed_when: false

- name: Install Tailscale using official script (only if not installed)
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL https://tailscale.com/install.sh | sh
  args:
    executable: /bin/bash
  when: _ts_version.rc != 0

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled.service
    enabled: true
    state: started
    daemon_reload: true

# -------------------------
# Enforce key-only authentication
# -------------------------
- name: Fail if no auth key provided
  ansible.builtin.assert:
    that:
      - (tailscale_auth_key | default('') | length) > 0
    fail_msg: "tailscale_auth_key is required (key-only authentication enforced)."
    success_msg: "Auth key present."

# -------------------------
# Normalize user variables
# -------------------------
- name: Normalize routes into raw string
  ansible.builtin.set_fact:
    _ts_routes_raw_str: >-
      {{
        (tailscale_advertise_routes | join(','))
        if (tailscale_advertise_routes is sequence and (tailscale_advertise_routes is not string))
        else (tailscale_advertise_routes | default('') | string)
      }}

- name: Normalize routes into list
  ansible.builtin.set_fact:
    _ts_routes_list: >-
      {{
        _ts_routes_raw_str
        | regex_replace('\\s+', '')
        | split(',')
        | reject('equalto', '')
        | list
      }}

- name: Normalize extra flags into list
  ansible.builtin.set_fact:
    _ts_extra_flags_list: >-
      {{
        (tailscale_extra_flags
          if (tailscale_extra_flags is sequence and (tailscale_extra_flags is not string))
          else (tailscale_extra_flags | default('') | string | split())
        )
      }}

# ---------------------------------------
# Build base command parts (avoid double spaces)
# ---------------------------------------
- name: Build base tailscale up command parts
  ansible.builtin.set_fact:
    _ts_cmd_parts_base: >-
      {{
        ['tailscale up']
        + (
            (_ts_routes_list | length > 0)
            | ternary(['--advertise-routes=' + (_ts_routes_list | join(','))], [])
          )
        + (
            tailscale_advertise_exit_node
            | ternary(['--advertise-exit-node'], [])
          )
        + (
            (_ts_extra_flags_list | length > 0)
            | ternary(_ts_extra_flags_list, [])
          )
      }}

# ---------------------------------------
# Detect current status; bring down if online
# ---------------------------------------
- name: Probe current Tailscale status (JSON)
  ansible.builtin.command: tailscale status --json
  register: _ts_status_before
  failed_when: false
  changed_when: false

- name: Determine whether Tailscale is online
  ansible.builtin.set_fact:
    _ts_online_before: >-
      {{
        (_ts_status_before.stdout | default('') != '')
        and ((_ts_status_before.stdout | from_json).Self.Online | default(false))
      }}

- name: Bring Tailscale down if it is online (to re-apply fresh params)
  ansible.builtin.command: tailscale down
  register: _ts_down
  failed_when: false
  changed_when: _ts_online_before | bool
  when: _ts_online_before | bool

- name: Restart tailscaled before applying new params (optional but robust)
  ansible.builtin.systemd:
    name: tailscaled.service
    state: restarted
  when: tailscale_restart_daemon_before_up | default(true) | bool

# ---------------------------------------
# Build exec/public commands (split across tasks!)
# ---------------------------------------
- name: Build command parts with auth key
  ansible.builtin.set_fact:
    _ts_cmd_parts_exec: "{{ _ts_cmd_parts_base + ['--auth-key=' ~ tailscale_auth_key] }}"
    _ts_cmd_parts_public: "{{ _ts_cmd_parts_base + ['--auth-key=********'] }}"
    _ts_cmd_parts_exec_reset: "{{ _ts_cmd_parts_base + ['--auth-key=' ~ tailscale_auth_key, '--reset'] }}"

- name: Join exec/public commands
  ansible.builtin.set_fact:
    _tailscale_up_cmd_exec: "{{ _ts_cmd_parts_exec | join(' ') }}"
    _tailscale_up_cmd_exec_reset: "{{ _ts_cmd_parts_exec_reset | join(' ') }}"
    _tailscale_up_cmd_public: "{{ _ts_cmd_parts_public | join(' ') }}"

- name: Show built tailscale up command (masked)
  ansible.builtin.debug:
    msg: "tailscale command: {{ _tailscale_up_cmd_public }}"
  when: tailscale_debug | bool

# ---------------------------------------
# First attempt: tailscale up
# ---------------------------------------
- name: Run 'tailscale up' (first attempt)
  ansible.builtin.command: "{{ _tailscale_up_cmd_exec }}"
  register: _ts_up_try
  failed_when: false
  no_log: true
  changed_when: >
    _ts_up_try.rc == 0 and
    (
      ('logged in' in ((_ts_up_try.stdout | default('') ~ _ts_up_try.stderr | default('')) | lower)) or
      ('success' in ((_ts_up_try.stdout | default('') ~ _ts_up_try.stderr | default('')) | lower)) or
      ('configuration changed' in ((_ts_up_try.stdout | default('') ~ _ts_up_try.stderr | default('')) | lower))
    )

# ---------------------------------------
# Auto-recovery: try again with --reset if first attempt failed
# ---------------------------------------
- name: Run 'tailscale up --reset' (auto-recovery on failure)
  ansible.builtin.command: "{{ _tailscale_up_cmd_exec_reset }}"
  register: _ts_up_try_reset
  failed_when: false
  no_log: true
  when:
    - _ts_up_try.rc | int != 0
    - tailscale_up_auto_reset_on_failure | default(true) | bool

- name: Fail early if both 'up' attempts failed
  ansible.builtin.fail:
    msg: >-
      Tailscale could not be brought up with the provided parameters.
      First attempt rc={{ _ts_up_try.rc | default('n/a') }};
      stdout="{{ _ts_up_try.stdout | default('') | regex_replace('\\n',' ') | trim }}";
      stderr="{{ _ts_up_try.stderr | default('') | regex_replace('\\n',' ') | trim }}".
      {{ 'Second attempt (--reset) rc=' ~ (_ts_up_try_reset.rc | string)
         ~ '; stdout="' ~ (_ts_up_try_reset.stdout | default('') | regex_replace('\\n',' ') | trim)
         ~ '"; stderr="' ~ (_ts_up_try_reset.stderr | default('') | regex_replace('\\n',' ') | trim) ~ '"'
         if (_ts_up_try_reset is defined) else '' }}
      Check flags in tailscale_extra_flags / routes / exit-node and server policies.
  when:
    - _ts_up_try.rc | int != 0
    - (_ts_up_try_reset is not defined or _ts_up_try_reset.rc | int != 0)

# ---------------------------------------
# Wait until online (only if up succeeded)
# ---------------------------------------
- name: Wait until Tailscale reports online
  ansible.builtin.command: tailscale status --json
  register: _ts_status_json
  changed_when: false
  until: >
    (_ts_status_json.stdout | default('')) != '' and
    ((_ts_status_json.stdout | from_json).Self.Online | default(false))
  retries: "{{ tailscale_wait_retries | default(20) }}"
  delay: "{{ tailscale_wait_delay_seconds | default(3) }}"

- name: Assert node is online/authorized
  ansible.builtin.assert:
    that:
      - (_ts_status_json.stdout | default('')) != ''
      - (_ts_status_json.stdout | from_json).Self.Online | default(false)
    fail_msg: >-
      Tailscale is not online after applying new parameters.
      Verify flags and node permissions.
    success_msg: "Tailscale is online and authorized."

# Optional info (idempotent equivalent to systemctl status)
- name: Read tailscaled status (informational)
  ansible.builtin.systemd:
    name: tailscaled.service
  register: _tailscaled_status
  changed_when: false
