# ansible-playbook main.yml -i hosts.yml -l <host>
# ansible-playbook main.yml -i hosts.yml --tags <tag1>,<tag2>
# ansible-playbook main.yml -i hosts.yml -e <variable>=<value>
#
# Get a list of facts:
# ansible -m setup
# ansible loki -m setup -a 'filter=ansible_architecture'
#
# Ask for pw insted of using SSH key
# --ask-pass
# --ask-become-pass

# GENERAL CONFIGURATIONS
# ────────────────────────────────────────────────────────── #
- name: Import setup-essentials.yml
  import_playbook: setup-essentials.yml
  tags: [setup-essentials, sudo]

# GROUP SPECIFIC SETUP
# ────────────────────────────────────────────────────────── #

#    PROXMOX: HOSTS
- name: Import setup-proxmox-hosts.yml
  import_playbook: setup-proxmox-hosts.yml

#    PROXMOX: CT & VMs
- name: Import setup-lxc-vm.yml
  import_playbook: setup-lxc-vm.yml

#    ADBLOCK
- name: Import setup-adblock.yml
  import_playbook: setup-adblock.yml

#    DOCKER
- name: Import setup-docker.yml
  import_playbook: setup-docker.yml

#    VPN-GATEWAYS
- name: Import setup-vpn_gw_ext.yml
  import_playbook: setup-vpn_gw_ext.yml

- name: Import setup-vpn_gw_hetzner.yml
  import_playbook: setup-vpn_gw_hetzner.yml

#    NAS
- name: Import setup-nas.yml
  import_playbook: setup-nas.yml

#    MacOS
- name: Improt setup-macos.yml
  import_playbook: setup-macos.yml

# CLIENT SPECIFIC CONFIGURATIONS
# ────────────────────────────────────────────────────────── #

- name: Setup for pve-ct-iobroker

  hosts:
    - pve-ct-iobroker

  become: true

  tags: pve-ct-iobroker

  # TODO add role my.iobroker
  roles:
    - role: my.smartmeter
      tags: role-smartmeter

  tasks:
    # TODO move to my.essentials
    - name: Check if source path exists
      ansible.builtin.stat:
        path: files/hosts/pve_hosts/
      register: src_path_check

    - name: Copy scripts if source path exists
      become: true
      become_user: "{{ my_essentials_user_username }}"
      ansible.builtin.copy:
        src: files/hosts/pve-ct-iobroker/
        dest: ~/bin/
        mode: "0755"
      when: src_path_check.stat.exists
      tags: copy-scripts

    - name: Create cronjob for iface metric @ reboot
      ansible.builtin.cron:
        name: iface metric
        special_time: reboot
        job: ifmetric eth0 100 && ifmetric eth1 200
      tags: crontab

    ### copy rsync-backups.sh
    - name: Copy rsync-backups.sh
      become: true
      become_user: "{{ my_essentials_user_username }}"
      ansible.builtin.copy:
        src: files/hosts/pve-ct-iobroker/rsync-backups.sh
        dest: ~/bin/rsync-backups.sh
        mode: "0755"
      tags: copy-scripts, rsync-backups

    - name: Create cronjob for rsync-backups.sh
      ansible.builtin.cron:
        name: setup crontab for rsync-backups.sh
        minute: "00"
        hour: "10"
        job: /home/darkiop/bin/rsync-backups.sh >/dev/null 2>&1
      tags: crontab, crontab-rsync-backups, rsync-backups

- name: Setup for pve-ct-pihole

  hosts:
    - pve-ct-pihole

  become: true

  roles:

    ## Pi-hole
    - role: my.pihole
      tags: role-pihole

- name: Setup for loki-new
  hosts: loki-new

  become: true

  roles:

    # TODO add role my.named
    # TODO add role my.tailscale

    ## https://github.com/geerlingguy/ansible-role-security
    - role: geerlingguy.security
      tags: role-security

    # Adblock configuration in host: setup-adblock.yml
    # - role: my.pihole # TODO Port 53 in use by pihole and named
    #   tags: role-pihole

    ## (https://github.com/bertvv/ansible-role-samba)
    - role: my.samba
      tags: role-samba

    - role: my.smartmeter
      tags: role-smartmeter

    - role: my.tailscale
      tags: role-tailscale

    # - role: my.named # TODO Port 53 in use by pihole and named
    #   tags: role-named

    ## https://github.com/geerlingguy/ansible-role-docker
    - role: my.docker
      tags: role-docker

  tasks:
    - name: Disable Wifi
      ansible.builtin.lineinfile:
        path: /boot/firmware/config.txt
        line: dtoverlay=disable-wifi
        insertafter: "[all]"
        create: true
        mode: "0755"
      tags: rpi-config

    - name: Disable BT
      ansible.builtin.lineinfile:
        path: /boot/firmware/config.txt
        line: dtoverlay=disable-bt
        insertafter: "[all]"
        create: true
        mode: "0755"
      tags: rpi-config

    - name: Copy arp.sh for wakeonlan
      become: true
      become_user: "{{ my_essentials_user_username }}"
      ansible.builtin.copy:
        src: files/hosts/loki/scripts/arp.sh
        dest: ~/bin/
        mode: "0777"
      tags: crontab, crontab-arp, copy-scripts

    - name: Create cronjob for arp -s (needed for wakeonlan)
      ansible.builtin.cron:
        name: setup crontab for arp for wakeonlan
        minute: "*"
        hour: "*"
        job: /home/darkiop/bin/arp.sh >/dev/null 2>&1
      tags: crontab, crontab-arp

    - name: Copy backup_bind.sh
      become: true
      become_user: "{{ my_essentials_user_username }}"
      ansible.builtin.copy:
        src: files/hosts/loki/scripts/backup_bind.sh
        dest: ~/bin/
        mode: "0755"
      tags: bind-backup, copy-scripts

    - name: Create cronjob for backup_bind.sh
      ansible.builtin.cron:
        name: setup crontab for backup_bind.sh
        minute: "00"
        hour: "12"
        job: /home/darkiop/bin/backup_bind.sh >/dev/null 2>&1
      tags: crontab, crontab-bind-backup, bind-backup

- name: Setup for pbs-odin

  hosts:
    - pbs-odin

  roles:
    - role: my.pbs
      tags: role-pbs

  tasks:
    - name: Mount odin:/pbs-pve and ensure it is present in /etc/fstab
      become: true
      ansible.posix.mount:
        path: /mnt/pbs-odin
        src: 192.168.1.30:/volume1/pbs-pve
        fstype: nfs
        opts: defaults
        state: mounted
      tags: proxmox-backup-server-config, mount

    - name: Create Proxmox-Backup-Server datastore.cfg
      become: true
      ansible.builtin.copy:
        dest: /etc/proxmox-backup/datastore.cfg
        owner: root
        group: backup
        mode: "0640"
        content: |
          datastore: pbs-odin
            gc-schedule sat 10:00
            path /mnt/pbs-odin
      tags: proxmox-backup-server-config

- name: Setup for pbs-freya

  hosts:
    - pbs-freya

  roles:
    - role: my.pbs
      tags: role-pbs

  tasks:
    - name: Create Proxmox-Backup-Server datastore.cfg
      become: true
      ansible.builtin.copy:
        dest: /etc/proxmox-backup/datastore.cfg
        owner: root
        group: backup
        mode: "0640"
        content: |
          datastore: pbs-freya
            gc-schedule daily
            path /data
            prune-schedule daily
      tags: proxmox-backup-server-config

# TEST
# ────────────────────────────────────────────────────────── #

- name: Setup for Playbook tests (ubuntu-based)

  hosts:
    - test-host-ubuntu

  become: true

  roles:
    - role: my.essentials                   # Ubuntu: ✅
      tags: role-essentials
    - role: my.ssh                          # Ubuntu: ✅
      tags: role-ssh
    - role: my.wireguard-client             # Ubuntu: ✅
      tags: role-wireguard-client
    - role: my.tailscale                    # Ubuntu: ✅
      tags: role-tailscale
    # - role: my.mqtt                       # Ubuntu: ✅
    #   tags: role-mqtt
    # - role: my.named                      # Ubuntu: ✅
    #   tags: role-named
    # - role: my.docker                     # Ubuntu: ✅
    #   tags: role-docker
    # - role: my.pihole                     # Ubuntu: ✅ TODO Upgrade to pihole V6
    #   tags: role-pihole
    # - role: my.pbs                        # Ubuntu: ⚠️ Only for Debian systems
    #   tags: role-pbs
    # - role: my.smartmeter                 # Ubuntu: ✅
    #   tags: role-smartmeter
    # - role: my.samba                      # Ubuntu: ✅
    #   tags: role-samba
    # - role: my.pdm                        # Ubuntu: ⚠️ Only for Debian systems
    #   tags: role-pdm

- name: Setup for Playbook tests (debian-bassed)

  hosts:
    - test-host-debian

  become: true

  roles:
    - role: my.essentials                 # Debain: ✅
      tags: role-essentials
    - role: my.ssh                        # Debian: ✅
      tags: role-ssh
    # - role: my.mqtt                       # Debian: ✅
    #   tags: role-mqtt
    # - role: my.named                      # Debian: ✅
    #   tags: role-named
    # # - role: my.docker                     # Debian: ✅
    #   tags: role-docker
    - role: my.pihole                     # Debian: ✅ TODO Upgrade to pihole V6
      tags: role-pihole
    # - role: my.pbs                        # Debian: ✅
    #   tags: role-pbs
    # - role: my.smartmeter                 # Debian: ✅
    #   tags: role-smartmeter
    # - role: my.samba                      # Debian: ✅
    #   tags: role-samba
    # - role: my.pdm                        # Debian: ✅
    #   tags: role-pdm
    # - role: my.tailscale
    #   tags: role-tailscale
